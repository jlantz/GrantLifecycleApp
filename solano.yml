# Use Python 2.7 for scripts
python:
  python_version: 2.7

system:
  queue:
    - branch: master
      queue: default
    - branch: "feature/*"
      queue: feature

hooks:
  pre_setup: |
    set -e # Exit on error
    git clone https://github.com/SalesforceFoundation/CumulusCI CumulusCI
    cd CumulusCI
    git fetch --all
    git checkout features/cloud-ci-integrations
    pip install -r requirements.txt
    cd ..
    mkdir apex_debug_logs

  post_build: "cumulusci ci next_step"

environment:
  CUMULUSCI_PATH: CumulusCI
  DEBUG_TESTS: true
  CUMULUSCI_STEPS_FEATURE: ['deploy',]
  CUMULUSCI_STEPS_MASTER: ['deploy','package_beta','deploy_beta']

test_pattern: 
  - 'none'

plan:
  - profile: deploy
    sets: next_profile
  - profile: "{{ next_profile }}"
    sets: next_profile
  - profile: "{{ next_profile }}"

profiles:
  deploy:
    tests:
      - type: junit
        command: cumulusci ci deploy
        report_files:
        - "test_results_junit.xml"

  package_beta:
    tests:
      - type: custom
        command: cumulusci package_beta $TDDIUM_CURRENT_COMMIT --create-release

  beta_deploy:
    tests:
      - git fetch --all; cumulusci ci beta_deploy "`git describe --tags | grep 'beta\/' | tail -1`" "$TDDIUM_CURRENT_COMMIT" --run-tests

collect:
  repo:
    - package.properties
    - test_results.json
    - test_results_junit.xml
